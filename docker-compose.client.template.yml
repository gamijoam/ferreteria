version: '3.8'

services:
  # ============================================
  # BACKEND DEL CLIENTE
  # ============================================
  backend:
    image: ghcr.io/gamijoam/ferreteria-backend:latest
    container_name: ${CLIENT_NAME}-backend
    restart: unless-stopped
    environment:
      # Base de Datos (Cada cliente tiene su propia DB en el mismo host o en un servicio externo)
      # Aquí asumimos que usas la red interna o un servicio cloud.
      # Para simplicidad en VPS único, usaremos una DB dockerizada por cliente o un shared cluster.
      # OPCIÓN 1: DB Por cliente (más aislado, más consumo de RAM) -> Se añade servicio 'db' abajo
      # OPCIÓN 2: Cluster compartido -> Se apunta a host.docker.internal o nombre de servicio si están en la misma red
      
      # Usaremos DB Dedicada por Stack para aislamiento total en este ejemplo
      DATABASE_URL: postgresql://${CLIENT_NAME}:${CLIENT_DB_PASSWORD}@db:5432/${CLIENT_NAME}_db
      
      POSTGRES_USER: ${CLIENT_NAME}
      POSTGRES_PASSWORD: ${CLIENT_DB_PASSWORD}
      POSTGRES_DB: ${CLIENT_NAME}_db
      
      # Configuración App
      SECRET_KEY: ${CLIENT_SECRET_KEY}
      ALLOWED_ORIGINS: "https://${DOMAIN},https://www.${DOMAIN}"
      ENVIRONMENT: production
      
      # Licenciamiento
      LICENSE_MODE: CLOUD
      CLOUD_LICENSE_KEY: ${CLIENT_LICENSE_KEY}
      VIRTUAL_HOST: ${DOMAIN}
      
    networks:
      - default
      - proxy-public
    depends_on:
      - db
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${CLIENT_NAME}-api.rule=Host(`${DOMAIN}`) && PathPrefix(`/api`, `/ws`, `/docs`)"
      - "traefik.http.routers.${CLIENT_NAME}-api.entrypoints=websecure"
      - "traefik.http.routers.${CLIENT_NAME}-api.tls.certresolver=myresolver"
      - "traefik.http.services.${CLIENT_NAME}-api.loadbalancer.server.port=8000"

  # ============================================
  # BASE DE DATOS DEL CLIENTE (Aislamiento total)
  # ============================================
  db:
    image: postgres:15-alpine
    container_name: ${CLIENT_NAME}-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${CLIENT_NAME}
      POSTGRES_PASSWORD: ${CLIENT_DB_PASSWORD}
      POSTGRES_DB: ${CLIENT_NAME}_db
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - default

  # ============================================
  # FRONTEND DEL CLIENTE
  # ============================================
  frontend:
    image: ghcr.io/gamijoam/ferreteria-frontend:latest
    container_name: ${CLIENT_NAME}-frontend
    restart: unless-stopped
    networks:
      - proxy-public
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${CLIENT_NAME}-web.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.${CLIENT_NAME}-web.entrypoints=websecure"
      - "traefik.http.routers.${CLIENT_NAME}-web.tls.certresolver=myresolver"
      - "traefik.http.services.${CLIENT_NAME}-web.loadbalancer.server.port=80"

networks:
  proxy-public:
    external: true

volumes:
  db_data:
